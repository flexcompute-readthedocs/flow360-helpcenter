# User-defined dynamics

*User-defined dynamics (UDD) is a powerful feature in Flow360 that allows you to implement custom control laws and coupled physics within your simulations. You define state variables that evolve according to mathematical expressions you specify, creating feedback loops where flow solution quantities influence the simulation in real-time.*

## **Overview**

User Defined Dynamics enables you to:

- **Read from the flow solution**: Access flow quantities such as forces, moments, pressure coefficients, or other solution variables
- **Compute custom quantities**: Calculate derived values using state variables, constants, and input variables
- **Control simulation parameters**: Influence boundary conditions, rotation rates, angles of attack, or other simulation inputs

This creates a feedback loop where the flow solution affects the dynamics, and the dynamics affect the flow solution, enabling simulations of complex coupled phenomena.

## **Web UI Implementation**

> **Important**: Currently, User Defined Dynamics must be configured using JSON files in the Web UI. The Web UI does not yet provide a graphical interface for setting up UDD parameters. You will need to manually edit the case JSON file to add the User Defined Dynamics configuration.

> **Recommendation**: We recommend using the Python API for implementing User Defined Dynamics, as it provides more flexibility, better debugging capabilities, and a more intuitive interface for complex dynamic scenarios.

## **Basic Structure**

A User Defined Dynamics system consists of the following components:

- **name**: A descriptive identifier for the dynamics system. Results are saved in ``results/udd_NAME_v2.csv`` where ``NAME`` matches this value.

- **input_vars**: List of flow solution variables that your dynamics system reads from the simulation. These can include force and moment coefficients (``CL``, ``CD``, ``CM``), force and moment components (``forceX``, ``forceY``, ``forceZ``, ``momentX``, ``momentY``, ``momentZ``), BET disk variables (``bet_NUM_torque``, ``bet_NUM_thrust``), or other available solution variables.

- **constants**: Named constant values used throughout your expressions. These can include physical constants (density, speed of sound), geometric parameters (rotation centers, axes), control parameters (proportional gain ``Kp``, integral gain ``Ki``, target values), structural parameters (stiffness ``K``, damping ratio ``zeta``, natural frequency ``omega_N``, moment of inertia ``I``), or any other values needed for your calculations.

- **state_vars_initial_value**: Initial values for each state variable. State variables are referenced as ``state[0]``, ``state[1]``, ``state[2]``, etc. in your expressions. Each initial value can be a numeric constant (e.g., ``"0.0"``), an expression using constants, or an expression referencing simulation variables (e.g., ``"alphaAngle"``).

- **update_law**: List of C-syntax expressions that define how each state variable evolves over time. These expressions are evaluated at each pseudo-step and can:
  
  * Reference input variables, constants, state variables, and simulation variables (``pseudoStep``, ``physicalStep``, ``timeStepSize``, ``t``, ``alphaAngle``, etc.)
  * Implement control laws (e.g., PI controllers for maintaining target lift coefficients)
  * Implement structural dynamics (e.g., spring-mass-damper systems for aeroelastic coupling)
  * Calculate derived quantities (e.g., dimensionalization factors, transformed moments)
  * Use conditional logic based on ``pseudoStep`` or other conditions

- **output_vars**: Dictionary mapping output variable names to expressions that compute their values. Output variables directly control simulation parameters. Common output variables include:
  
  * ``alphaAngle``: Angle of attack
  * ``betaAngle``: Sideslip angle
  * ``theta``: Rotation angle (in radians) for rotating volume zones
  * ``omega``: Angular velocity (in radians per second) for rotating volume zones
  * ``omegaDot``: Angular acceleration (in radians per second squared) for rotating volume zones
  * ``bet_NUM_omega``: Angular velocity for BET disk (NUM is the disk index)
  
  **Caution**: Modifications to output variables directly affect the simulation.

- **input_boundary_patches**: (Optional) List of surface boundaries where input variables should be computed. If specified, quantities like ``CL`` or ``CD`` are computed only from these surfaces.

- **output_target**: (Optional) The target entity where output variables apply. For example, if controlling rotation with ``theta``, ``omega``, or ``omegaDot``, specify the rotating volume zone. If ``None``, output variables apply globally (e.g., ``alphaAngle``, ``betaAngle``).

> **Note**: All expressions and variables entered in User Defined Dynamics must be C-syntax compatible. For details on the syntax requirements and supported operations, see the Flow360 Python API documentation.

## **Best Practices**

1. Start with simple motions and gradually add complexity
2. Test your UDD implementation with coarse meshes before running full simulations
3. Ensure mesh rotation settings are appropriate for the expected range of motion
4. Monitor forces and moments during motion to ensure physical behavior
5. Use the Python API when possible for easier debugging and more intuitive configuration

## **Related Documentation**

For detailed implementation examples, please refer to the Flow360 Python API documentation. 
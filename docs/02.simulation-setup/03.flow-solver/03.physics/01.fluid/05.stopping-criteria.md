(stopping_criteria)=

# Stopping criteria

*Stopping criteria allow you to automatically terminate a simulation when monitored fields reach specified tolerance thresholds. The simulation stops when all configured criteria are satisfied simultaneously, providing efficient convergence control based on force coefficients, probe values, or surface probe data.*

---

## **Available Parameters**

| *Parameter* | *Description* |
|-------------|---------------|
| **Name** | A descriptive name for the stopping criterion |
| **Output type** | The category of output to monitor (Force, Probe, or Surface Probe) |
| **(Output name)** | The specific output instance to monitor (appears after selecting an **Output type**) |
| **Output field** | The specific scalar field within the selected output to monitor for convergence |
| **Tolerance** | The threshold for the moving deviation of the monitored field |
| **Tolerance window size** | The number of iterations over which to calculate the moving deviation |

---

## **Detailed Descriptions**

### **Name**

*A descriptive identifier for this stopping criterion.*

- **Default:** `"Criterion 1"`, `"Criterion 2"`, etc. (automatically assigned)
- **Example:** `"Lift convergence"`, `"Drag tolerance"`
> **Note:** Use descriptive names when configuring multiple criteria to easily identify which conditions triggered the simulation stop.

### **Output type**

*Specifies the category of output that contains the field to be monitored.*

- **Default:** None
- **Options:**
  - `Force`: Monitor force and moment coefficients from force outputs
  - `Probe`: Monitor flow variables from probe outputs
  - `Surface Probe`: Monitor flow variables from surface probe outputs
> **Notes:**
> - The chosen output type must be configured in the [Output section](../../../04.output/README.md) of your simulation setup before it can be used here.
> - This selection determines which specific output instances are available in the next dropdown menu.

### **Output name**

*Selects a specific, named output instance of the chosen **Output type** to monitor.*

- **Default:** None
- **Example:** `"Force output1"`, `"ProbeOutput1"`, `"SurfaceProbe1"`
> **Notes:**
> - You must define an output (e.g., a Force output, [`ProbeOutput`](../../../04.output/02.outputs-list/07.probe-outputs.md), or [`Surface Probe Output`](../../../04.output/02.outputs-list/09.surface-probe-outputs.md)) in the Output section before it can be selected here.
> - The list of available names is filtered based on the selected **Output type**.
> - Ensure the output is configured with the **Output field** you want to monitor.

### **Output field**

*The specific scalar field within the selected output to monitor for convergence.*

- **Default:** None
- **Example:** `CD` (drag coefficient), `CL` (lift coefficient), `Cp` (pressure coefficient), `Mach` (Mach number)
> **Notes:**
> - The selected field must be one of the `output_fields` defined in the selected output instance.
> - For Force outputs, common fields include force coefficients such as `CL`, `CD`, `CM` (pitching moment), `CY` (side force), etc.
> - For Probe and Surface Probe outputs, you can monitor any of the configured output fields (e.g., `Cp`, `Mach`, `Pressure`, `Velocity`).
> - If using a `UserVariable` for the output field, the dimensions of the tolerance must match the dimensions of the field.

### **Tolerance**

*Convergence threshold. The simulation stops when the moving deviation of the **Output field** is less than this value.*

- **Default:** `0.01`
- **Example:** `1e-5`, `0.001`
> **Notes:**
> - This value is non-dimensional if the monitored field is a string-defined default field (e.g., `'CL'`, `'CD'`, `'Cp'`).
> - If using a `UserVariable` for the output field, the dimensions of the tolerance must match the dimensions of the field.
> - Smaller tolerance values require stricter convergence and may result in longer simulation times.
> - For force coefficients, typical values range from `1e-4` to `1e-2` depending on the required accuracy.

### **Tolerance window size**

*The number of data points used for the moving window to calculate the deviation of the monitored field.*

- **Default:** `100`
- **Example:** `50`, `200`
> **Notes:**
> - The value must be an integer greater than or equal to 2.
> - A larger window provides a more stable measure of convergence but may react slower to changes in the monitored field.
> - A smaller window is more sensitive to fluctuations and may cause premature stopping if the solution has periodic oscillations.
> - For steady-state simulations, a window size of 50-200 iterations is typically appropriate.
> - For unsteady simulations, consider using a window size based on the number of time steps that represent a meaningful averaging period.

---

## **How Stopping Criteria Work**

When you configure one or more stopping criteria:

1. **Monitoring**: Flow360 continuously monitors the specified output fields during the simulation.
2. **Deviation Calculation**: For each criterion, the solver calculates the moving deviation (typically standard deviation or range) of the monitored field over the specified tolerance window size.
3. **Convergence Check**: When the deviation falls below the tolerance threshold, that criterion is considered satisfied.
4. **Simulation Stop**: The simulation stops only when **all** configured criteria are satisfied simultaneously.

> **Important:** All stopping criteria must be met at the same time for the simulation to stop. If you configure multiple criteria, the simulation will continue until every single criterion has reached its tolerance threshold.

---

## **Common Use Cases**

### **Force Coefficient Convergence**

Stop the simulation when aerodynamic coefficients have converged:

- **Output type:** `Force`
- **Output field:** `CL` (or `CD`, `CM`, etc.)
- **Tolerance:** `1e-5` (for high accuracy) or `0.01` (for faster results)
- **Tolerance window size:** `100`

### **Probe Value Monitoring**

Stop when a specific flow variable at a probe location has stabilized:

- **Output type:** `Probe`
- **Output field:** `Mach`, `Pressure`, or a `UserVariable`
- **Tolerance:** `0.001`
- **Tolerance window size:** `50`

### **Surface Probe Convergence**

Monitor surface variables at specific locations:

- **Output type:** `Surface Probe`
- **Output field:** `Cp`, `Cf`, or other surface-specific fields
- **Tolerance:** `1e-4`
- **Tolerance window size:** `100`

---

<details>
<summary><h3 style="display:inline-block"> üí° Tips</h3></summary>

- **For force-based convergence:**
  - Monitor the most relevant force coefficient for your application (e.g., `CL` for lift-critical cases, `CD` for drag optimization).
  - Use tolerances between `1e-4` and `1e-2` depending on your accuracy requirements.
  - Consider monitoring multiple force coefficients if your analysis requires multiple metrics to be converged.

- **For probe-based monitoring:**
  - Place probes at critical locations where flow behavior indicates overall solution convergence.
  - Monitor variables that are directly relevant to your analysis goals.
  - Use `UserVariable` expressions if you need to monitor derived quantities.

- **Window size selection:**
  - Larger windows (100-200) are more conservative and reduce false stops from transient fluctuations.
  - Smaller windows (50-100) provide faster response to actual convergence.
  - For unsteady simulations, base the window size on the characteristic timescale of your flow phenomena.

- **Multiple criteria:**
  - Use multiple criteria when you need to ensure convergence of different aspects (e.g., both lift and drag coefficients).
  - Remember that all criteria must be satisfied simultaneously, so avoid setting overly strict tolerances that may never all be met at once.

- **Output configuration:**
  - Ensure outputs are configured with appropriate output fields before setting up stopping criteria.
  - Outputs should be saved frequently enough (low frequency value or `-1` for every iteration) to provide sufficient data for the tolerance window calculation.

</details>

---

<details>
<summary><h3 style="display:inline-block"> ‚ùì Frequently Asked Questions</h3></summary>

- **What happens if a stopping criterion is never met?**  
  > The simulation continues until the maximum number of iterations or time steps is reached. Stopping criteria are additional convergence checks; they do not override the maximum iteration limit set in time stepping settings.

- **Can I use stopping criteria with unsteady simulations?**  
  > Yes, stopping criteria work with both steady and unsteady simulations. For unsteady simulations, the tolerance window should be sized appropriately for the characteristic timescales of your flow phenomena.

- **How is the "deviation" calculated?**  
  > The deviation is typically calculated as the standard deviation or range of the monitored field values over the tolerance window. The exact method depends on the output type and field being monitored.

- **What's the difference between stopping criteria and maximum iterations?**  
  > Maximum iterations (set in time stepping) defines an upper bound on simulation duration. Stopping criteria provide intelligent early termination when convergence is detected, potentially saving computational resources.

- **Can I disable a stopping criterion without deleting it?**  
  > Currently, you must remove criteria you don't want to use. The simulation only checks criteria that are configured and active.

- **Do I need to configure outputs separately?**  
  > Yes, you must first configure the outputs (Force, Probe, or Surface Probe) in the Output section with the appropriate output fields. Only outputs that are already defined can be selected in the stopping criteria configuration.

- **What output fields are available for Force outputs?**  
  > Force outputs typically include force and moment coefficients such as `CL` (lift), `CD` (drag), `CM` (pitching moment), `CY` (side force), `CR` (roll moment), and `CN` (yaw moment). The exact fields depend on how the force output is configured.

- **Can I monitor custom fields using UserVariables?**  
  > Yes, if your output includes `UserVariable` expressions, you can monitor those fields. Ensure the tolerance units match the dimensions of your custom field.

</details>

---

## **Related**

- [Probe Outputs](../../../04.output/02.outputs-list/07.probe-outputs.md) - Setting up probe outputs
- [Surface Probe Outputs](../../../04.output/02.outputs-list/09.surface-probe-outputs.md) - Setting up surface probe outputs

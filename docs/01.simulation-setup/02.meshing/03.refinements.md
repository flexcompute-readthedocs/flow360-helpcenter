# Refinements

This document describes how to create and configure mesh refinements in Flow360. Refinements allow you to control mesh resolution in specific regions of your geometry to better capture flow features or geometric details.

## üìã Available Refinement Types

| **Type** | **Description** | **Applicable To** |
|----------|----------------|------------------|
| Surface Edge Refinement | Controls mesh resolution near edges | Edges |
| Surface Refinement | Controls surface mesh cell size | Surfaces |
| Boundary Layer Refinement | Creates prismatic layers near walls | Surfaces |
| Passive Spacing | Controls mesh behavior without direct refinement | Surfaces |
| Uniform Refinement | Creates uniform mesh spacing in a region | Boxes and cylinders |
| Axisymmetric Refinement | Creates structured-like mesh with cylindrical bias | Cylinders |

## üîç Detailed Descriptions

### Surface Edge Refinement

Surface edge refinement allows precise control of mesh resolution near geometric edges, which is crucial for capturing features like leading edges, trailing edges, and other regions with high curvature.

#### Available Parameters

| Parameter | Description | Units |
|-----------|-------------|-------|
| Method | Refinement method (Height/Angle/Project aniso spacing/Aspect ratio) | - |
| Height | First layer height when using height-based method | Length |
| Angle | Curvature resolution angle when using angle-based method | Degrees |
| Aspect Ratio | Maximum aspect ratio when using aspect ratio method | - |
| Assigned Edges | Edges where refinement will be applied | - |

*Note: Height, Angle, and Aspect Ratio are only required when their respective method is selected*

#### Method Details

1. **Height-Based Method**
   - Specifies the first layer height of anisotropic layers
   - Best for precise control of mesh resolution
   - Recommended for aerodynamic surfaces where y+ control is important

2. **Angle-Based Method**
   - Controls mesh resolution based on local curvature
   - Automatically adjusts refinement to geometry features
   - Useful for complex curved geometries

3. **Project Aniso Spacing**
   - Projects spacing from adjacent regions
   - Ensures smooth transitions between different mesh regions
   - Helpful for maintaining mesh continuity

4. **Aspect Ratio Method**
   - Controls element shape through aspect ratio limits
   - Prevents highly stretched elements
   - Useful for quality control in transition regions

### Surface Refinement

Surface refinement controls the maximum size of surface mesh elements, ensuring adequate resolution on geometric surfaces.

#### Available Parameters

| Parameter | Description | Units |
|-----------|-------------|-------|
| Max Edge Length | Maximum allowed length of mesh edges | Length |
| Assigned Surfaces | Surfaces where refinement will be applied | - |

#### Usage Guidelines

- Set max edge length based on the smallest geometric feature you need to resolve
- Consider using smaller values in regions of high curvature
- Typical values range from 1% to 10% of characteristic length
- Ensure smooth transition to neighboring regions

### Boundary Layer Refinement

Boundary layer refinement creates prismatic layers near wall surfaces to resolve viscous effects accurately.

#### Available Parameters

| Parameter | Description | Units |
|-----------|-------------|-------|
| First Layer Thickness | Height of the first prismatic layer | Length |
| Growth Rate | Growth rate for volume prism layers | - |
| Assigned Surfaces | Surfaces where refinement will be applied | - |

#### Design Considerations

- First layer thickness should be chosen to achieve desired y+ values
- Growth rate typically ranges from 1.1 to 1.3
- Number of layers is automatically calculated unless specified in meshing defaults
- Consider flow regime and Reynolds number when setting parameters

### Passive Spacing

Passive spacing provides control over mesh behavior without direct refinement specification.

#### Available Parameters

| Parameter | Description | Units |
|-----------|-------------|-------|
| Type | Spacing control method (Project aniso spacing/Unchanged) | - |
| Assigned Surfaces | Surfaces where refinement will be applied | - |

#### Type Options

1. **Project Aniso Spacing**
   - Projects spacing from neighboring volumes
   - Maintains mesh continuity
   - Useful for interface regions

2. **Unchanged**
   - Preserves existing surface mesh
   - Prevents modification during volume mesh generation
   - Helpful when surface mesh quality is already optimal

### Uniform Refinement

Uniform refinement creates regions of consistent mesh resolution, particularly useful for capturing off-body flow features.

#### Available Parameters

| Parameter | Description | Units |
|-----------|-------------|-------|
| Spacing | Target mesh spacing in the region | Length |
| Assigned Boxes and Cylinders | Volumes where refinement will be applied | - |

#### Best Practices

- For wake regions, extend 2-3 characteristic lengths downstream
- For shock regions, align refinement with expected shock angle
- Size refinement region 10% larger than expected flow feature
- Use \(\sqrt{3}\) times surface spacing for near-body regions

### Axisymmetric Refinement

Axisymmetric refinement creates structured-like mesh with cylindrical bias, ideal for rotating machinery and axisymmetric flow features.

#### Available Parameters

| Parameter | Description | Units |
|-----------|-------------|-------|
| Spacing Axial | Mesh spacing along cylinder axis | Length |
| Spacing Radial | Mesh spacing in radial direction | Length |
| Spacing Circumferential | Mesh spacing in circumferential direction | Length |
| Assigned Cylinders | Cylindrical regions where refinement will be applied | - |

#### Recommended Settings for Different Applications

**Propeller/Rotor Applications:**
- Radial spacing: 110-120% of rotor radius
- Axial spacing: 20+ layers for strong gradients
- Circumferential spacing: 
  - Coarse mesh: 540 cells
  - Medium mesh: 720 cells
  - Fine mesh: 900 cells
- Radial spacing: Match circumferential spacing for optimal quality

**Wake Regions:**
- Extend 2-3 diameters downstream
- Gradually increase spacing downstream
- Maintain aspect ratio below 1.5 for better wake resolution

---

<details>
<summary><h3 style="display:inline-block"> üí° Tips</h3></summary>

- Start with coarser refinements and gradually increase resolution where needed
- Use boundary layer refinement on all wall surfaces where viscous effects are important
- Ensure smooth transitions between regions of different refinement levels
- Consider using passive spacing on surfaces where direct control isn't needed
- For rotating machinery, combine boundary layer refinement with axisymmetric refinement
- Off-body refinement regions should:
  - Enclose geometry with 10% margin
  - Extend at least 2x characteristic length downstream
  - Account for flow angles and operating conditions
  - Use appropriate shapes for flow features (cylinder/rotor, box/wing)

</details>

---

<details>
<summary><h3 style="display:inline-block"> ‚ùì Frequently Asked Questions</h3></summary>

- **What happens if refinements overlap?**  
  > The finest (smallest) spacing will be used in overlapping regions.

- **How do I size refinement regions for wake capture?**  
  > Extend refinement at least 2x characteristic length downstream, with 10% margin around expected wake region.

</details>

---

<details>
<summary><h3 style="display:inline-block"> üêç Python Example Usage</h3></summary>

Here's an example showing how to configure various refinements using the Flow360 Python API:

```python
from flow360 import (
    SurfaceEdgeRefinement, 
    HeightBasedRefinement,
    AngleBasedRefinement,
    AspectRatioBasedRefinement,
    SurfaceRefinement,
    BoundaryLayer,
    PassiveSpacing,
    UniformRefinement,
    AxisymmetricRefinement,
    u
)

# Surface edge refinement using height-based method
edge_refinement = SurfaceEdgeRefinement(
    name="leading_edge",
    entities=[leading_edge],
    method=HeightBasedRefinement(value=0.001 * u.m)
)

# Surface edge refinement using angle-based method
edge_angle_ref = SurfaceEdgeRefinement(
    name="curved_edge",
    entities=[curved_edge],
    method=AngleBasedRefinement(value=5 * u.deg)
)

# Surface refinement
surface_ref = SurfaceRefinement(
    name="wing_surface",
    entities=[wing_surface],
    max_edge_length=0.05 * u.m
)

# Boundary layer refinement
bl_ref = BoundaryLayer(
    name="wing_bl",
    entities=[wing_surface],
    first_layer_thickness=1e-5 * u.m,
    growth_rate=1.2
)

# Passive spacing
passive_ref = PassiveSpacing(
    name="interface",
    type="projected",
    entities=[interface_surface]
)

# Uniform refinement in wake region
wake_ref = UniformRefinement(
    name="wake_region",
    entities=[wake_box],
    spacing=0.1 * u.m
)

# Axisymmetric refinement for propeller
prop_ref = AxisymmetricRefinement(
    name="propeller_region",
    entities=[prop_cylinder],
    spacing_axial=0.02 * u.m,
    spacing_radial=0.01 * u.m,
    spacing_circumferential=0.015 * u.m
)

# Add refinements to simulation parameters
params = SimulationParams(
    meshing=MeshingParams(
        refinements=[
            edge_refinement,
            edge_angle_ref,
            surface_ref,
            bl_ref,
            passive_ref,
            wake_ref,
            prop_ref
        ]
    )
)
```

</details> 